/*++----------------------------------------------------------------------------------------------------------------------------------------------------------------------
1. 项目名称：悟空找房h5
2. 文件名：libs -> location.js
3. 作者：zhaohuagang@lifang.com
4. 备注：H5地理定位封装
            使用cookie来进行定位数据的缓存，主要是为了和老站对接，cookie里面暂时只存了经纬度，如果需要更多，在代码里面添加，可以有：
            coords.latitude 	十进制数的纬度
            coords.longitude 	十进制数的经度
            coords.accuracy 	位置精度
            coords.altitude 	海拔，海平面以上以米计
            coords.altitudeAccuracy 	位置的海拔精度
            coords.heading 	方向，从正北开始以度计
            coords.speed 	速度，以米/每秒计
            timestamp 	响应的日期/时间
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
class Location {
    constructor({ cityApiUrl , success }) {        
        this.cityApiUrl = cityApiUrl || "" ;
        this.cookieKeyPrefix = "location_" ;  //cookie里面位置信息缓存的前缀
        this.success = success || $.noop ;  //拿到位置信息后的回调函数        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        发起定位，并根据浏览器是否支持cookie决定是否要将位置信息存储到缓存
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        this.orientate() ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    发起定位，并根据浏览器是否支持cookie决定是否要将位置信息存储到缓存
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    orientate() {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        判断浏览器是否支持H5的geolocation
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        if( ! navigator.geolocation ) {
            $.tips( "您的浏览器不支持定位地理位置" , 3 ) ;            
            return ;
        }
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        定义定位选项
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        let geoOpts = {
            enableHighAccuracy : false ,   //表示是否高精度可用，为Boolean类型，默认为false，如果开启，响应时间会变慢，同时，在手机设备上会用掉更多的流量，也就是money了。
            maximumAge : 0 , //表示应用程序的缓存时间。单位毫秒，默认是0，意味着每次请求都是立即去获取一个全新的对象内容。
            timeout : 10 * 1000  //表示等待响应的最大时间，默认是0毫秒，表示无穷时间。
        } ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        开始发起定位
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        navigator.geolocation.getCurrentPosition( (position) => {
            let latitude = position.coords.latitude ;
            let longitude = position.coords.longitude ;            
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            如果支持cookie就往cookie里面写经纬度
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            if( window.navigator.cookieEnabled ) {                
                $.cookie(this.cookieKeyPrefix + "latitude" , latitude) ;
                $.cookie(this.cookieKeyPrefix + "longitude" , longitude) ;
            }
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            根据经纬度反查城市信息
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $.ajax({
                url : this.cityApiUrl ,
                type : "GET" ,
                data : { "latitude" : latitude , "longitude" : longitude } ,
                dataType : "json" ,                                 
                error : (e) => {
                    $.tips( "通过经纬度反查城市接口错误！" , 3 ) ;
                } ,
                success : (data) => {                
                    if (data.status.toString() === "1") {                        
                        if(1) {
                            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                            用拿到的city模型和cookie里面的值做对比，如果相同其实不需要做什么
                            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                            this.success({ "latitude" : latitude , "longitude" : longitude }) ;
                        }
                        else {
                            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                            如果不同，就组织新的路由跳转
                            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                        }
                        
                    }
                    else $.tips( data.message , 3 ) ;
                }
            }) ;             
        } , ( error ) => {
            switch(error.code) {
                case error.PERMISSION_DENIED :  //用户阻止了授权
                this.fail() ;
                break ;

                case error.POSITION_UNAVAILABLE :  //定位信息无效
                this.fail() ;
                break ;

                case error.TIMEOUT :  //定位超时
                this.timeout() ;
                break ;

                case error.UNKNOWN_ERROR :  //其他不可预知的错误
                this.fail() ;
                break ;
            }
        } , geoOpts ) ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    定位超时处理：
    1. 弹出定位失败提示框
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    timeout() {
        $.modal({
            "id" : "orientateTimeoutDialog" ,            
            "content" : "定位失败<br>请手动选择您的城市" ,
            "buttons" : [
                { "text" : "去选择" , "className" : "goto-select-city" , "clickCallback" : () => { window.location.href = "/common/city/select" ; } } 
            ]
        }) ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    定位失败处理：直接跳城市选择页面    
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    fail() {
        window.location.href = "/common/city/select" ;
    }
    

}