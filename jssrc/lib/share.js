/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：悟空找房h5
 2. 页面名称：components -> share(微信分享)
 3. 作者：zhaohuagang@lifang.com
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
class Share {
    constructor() {        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        分享的标题
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        this.title = $("#wechatTitle").val() ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        分享的内容
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        this.content = $("#wechatContent").val() ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        分享的链接
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        this.linkUrl = window.location.href ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        分享的图片
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        this.imgUrl = $("#wechatImgUrl").val() ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        启动
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        this.onload() ; 
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    根据当前阶段环境拿到获取签名接口地址
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    getApiUrl() {
        let controller = new Controller ;
        let environment = controller.getEnv() ; 
        let apiPrefix = "//wechat.wkzf.com/" ;
        if (environment === "test") apiPrefix = "//10.0.18.79:8134/" ;       
        else if (environment === "sim") apiPrefix = "//wechat.sim.wkzf/" ;
        else  apiPrefix = "//wechat.wkzf.com/" ;
        return apiPrefix + "wx_js_sdk_sign.rest" ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    监听“分享到朋友圈”按钮点击、自定义分享内容及分享结果接口
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    wx_onMenuShareTimeline( title , linkUrl , imgUrl ) {
        wx.onMenuShareTimeline({
            title : title ,
            link : linkUrl ,
            imgUrl : imgUrl ,
            trigger : function(res) { } ,
            success : function(res) {} ,
            cancel : function(res) { } ,
            fail : function(res) { }
        }) ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    监听“发送给朋友”按钮点击
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    wx_onMenuShareAppMessage( title , linkUrl , content , imgUrl ) {
        wx.onMenuShareAppMessage({
            title : title , // 分享标题
            desc : content , // 分享描述
            link : linkUrl , // 分享链接
            imgUrl : imgUrl , // 分享图标
            type : "" , // 分享类型,music、video或link，不填默认为link
            dataUrl : "" , // 如果type是music或video，则要提供数据链接，默认为空
            success : function() {
                // 用户确认分享后执行的回调函数
                //alert("wx_onMenuShareAppMessage success " + linkUrl);
            } ,
            cancel : function() {
                // 用户取消分享后执行的回调函数
                // alert("wx_onMenuShareAppMessage cancel " + linkUrl);
            }
        }) ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    发送请求
     -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
     sendRequest() {
         $.ajax({
            url : this.getApiUrl() ,
            type : "GET" ,
            data : { requestUrl: window.location.href } ,
            dataType : "jsonp" ,                
            error : (e) =>  {
                //console.log("error" + e);
            } ,
            success : (result) => {
                let data = result.data ;
                wx.config({
                     debug : false , // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId : data.appid , // 必填，企业号的唯一标识，此处填写企业号corpid
                    timestamp : data.timestamp , // 必填，生成签名的时间戳
                    nonceStr : data.nonce_str , // 必填，生成签名的随机串
                    signature : data.signature , // 必填，签名，见附录1
                     jsApiList : ["onMenuShareAppMessage", "onMenuShareTimeline"] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                }) ;
            }
        }) ;
     }
     /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    页面加载的时候执行的公共逻辑
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    onload() {        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        请求完成之后执行ready方法
         -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        wx.ready(() => {
            wx.showOptionMenu() ;
            this.wx_onMenuShareTimeline( this.title , this.linkUrl , this.imgUrl ) ; //  监听“分享到朋友圈
            this.wx_onMenuShareAppMessage( this.title , this.linkUrl , this.content , this.imgUrl ) ; //  监听“发送给朋友”按钮点击
         }) ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        发送请求
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        this.sendRequest() ;
    }
}
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
类的初始化
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
$(document).ready(function() {
    new Share ;
}) ;