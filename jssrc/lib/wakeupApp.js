/*++----------------------------------------------------------------------------------------------------------------------------------------------------------------------
1. 项目名称：悟空找房h5
2. 文件名：components -> wakeupApp.js
3. 作者：zhaohuagang@lifang.com
4. 备注：唤醒APP
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
class WakeupApp {
    constructor({ element , androidSchemes , isoSchemes , androidDownloadLink , iosDownloadLink }) {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        地址配置
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        this.opts = {
            element : element ,
            androidSchemes : androidSchemes ,
            isoSchemes : isoSchemes ,
            androidDownloadLink : androidDownloadLink ,
            iosDownloadLink : iosDownloadLink
        } ;        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ua的值
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        this.ua = navigator.userAgent ; 
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        是否安装app标志
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        this.hasApp = true ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        全局的定时器
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        this.timer = null ;
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        全局的超时时间
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        this.timeout = 1500 ;        
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        给元素绑定事件
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        this.bindEvent() ;
    }
     /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    检测系统类型
    1.wechat :微信
    2.ios：苹果系统
    3.android ：安卓系统
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    system() {
        let system = "" ;
        if (this.ua.match(/MicroMessenger/i)) {
            system = "wechat" ;
        }
        else if (this.ua.match(/(iPhone|iPod|iPad);?/i)) {
            system = "ios" ;
        }
        else if (this.ua.match(/android/i)) {
            system = "android" ;
        }
        return system ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    检测浏览器类型及版本    
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    browser() {
        let browser = {} ;
		let ua =  this.ua.toLowerCase() ;
		if( ua.indexOf("safari") != -1 && ua.indexOf("browser") == -1 ) browser["name"] = "safari" ;
		if( ua.match(/version\/([\d.]+)/) ) browser["version"] = parseInt(ua.match(/version\/([\d.]+)/)[1]) ;
        return browser ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    tryToOpenApp
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    tryToOpenApp(t1) {
        let t2 = Date.now() ;
        if (! t1 || t2 - t1 < this.timeout + 200) {
            this.hasApp = false ;
        }
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    绑定事件到"打开app"的按钮，如果是微信环境，打开安卓下载链接
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    bindEvent() {
        $(this.opts.element).click(() => {
            if( this.system() === "wechat" ) {
                top.window.location = this.opts.androidDownloadLink ;
                return  ;
            }
            this.openDownloadLink() ;
            this.isHasApp() ;
        }) ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    打开跳转链接
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    openDownloadLink() {        
        window.setTimeout(() => {
            let system = this.system() ;
            let downloadUrl = "" ;
            if (system === "ios") downloadUrl = this.opts.iosDownloadLink ;
            else if (system === "android") downloadUrl = this.opts.androidDownloadLink ;
            if ( ! this.hasApp) {
                top.window.location = downloadUrl ;
                console.log("未安装") ;
            } 
            else console.log("已安装") ;
        } , 2000) ;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    本地是否安装app
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    isHasApp () {        
        let ifr = $('<iframe id="ifr" style="display:none;"></iframe>') ;
        let system = this.system() ;
        let browser = this.browser() ;
        let t1 = Date.now() ;
        if (system === "ios") {
            if( browser.name == "safari" && browser.version < 9 ) window.location.href = this.opts.isoSchemes ;
		    if(browser.name!="safari") window.location.href = this.opts.isoSchemes ;
        }
        else if (browser == "android") ifr.attr("src", this.opts.androidSchemes) ;
        $("body").append(ifr) ;
        this.timer = window.setTimeout(() => {
            this.tryToOpenApp(t1) ;
        } , this.timeout ) ;
    }
    

}