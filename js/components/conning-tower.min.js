"use strict";

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：悟空找房h5
 2. 页面名称：components -> conning-tower(列表页司令塔，包括返回、搜索、汉堡菜单等信息)
 3. 作者：zhaohuagang@lifang.com
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
var ConningTower = function () {
    function ConningTower(_ref) {
        var apiUrl = _ref.apiUrl,
            moduleType = _ref.moduleType;

        _classCallCheck(this, ConningTower);

        this.apiUrl = apiUrl; //搜索用的接口地址
        this.moduleType = moduleType; //模块类型，可以是：xf | esf | rent
        this.addEventListener();
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    组件相关dom节点事件绑定
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/


    _createClass(ConningTower, [{
        key: "addEventListener",
        value: function addEventListener() {
            var _this = this;

            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            点击城市选择入口弹出城市选择器并根据是否有了数据来决定是否需要请求接口渲染
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".conning-tower dl dt").click(function () {
                $(".city-selector").slideDown(200);
                if ($(".city-selector .tabs-frame").children().length) return;
                /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                请求业务城市数据并绘制，绘制完后绑定事件
                -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                _this.request({
                    apiUrl: "/api/common/businessCity",
                    requestData: {},
                    success: function success(result) {
                        var cities = _this.filterBusinessCity(result.data); //取出所有满足条件的城市清单                    
                        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                        绘制tabs-handle
                        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                        var $ul = "<ul class=\"tabs-handle\"><li class=\"on\" data-sign=\"domestic\">国内</li><li data-sign=\"overseas\">国际</li></ul>";
                        if (!Object.keys(cities.domestic).length || !Object.keys(cities.overseas).length) {
                            if (Object.keys(cities.domestic).length) $ul = "<ul class=\"tabs-handle\" style=\"display : none\"><li class=\"on\" data-sign=\"domestic\">国内</li><li data-sign=\"overseas\">国际</li></ul>";else $ul = "<ul class=\"tabs-handle\" style=\"display : none\"><li data-sign=\"domestic\">国内</li><li class=\"on\" data-sign=\"overseas\">国际</li></ul>";
                        }
                        $(".city-selector .caption").append($ul);
                        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                        绘制tabs-frame
                        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                        var $domesticFrame = $(document.createElement("DIV")).addClass("tabs-frame domestic");
                        if (Object.keys(cities.domestic).length) {
                            for (var key in cities.domestic) {
                                $domesticFrame.append("<span>" + key + "</span>");
                                cities.domestic[key].forEach(function (city) {
                                    $domesticFrame.append("<a data-cityid=\"" + city.cityId + "\" data-pinyin=\"" + city.pinyin + "\" data-cityType=\"" + city.cityType + "\">" + city.cityName + "</a>");
                                });
                            }
                        }
                        $(".city-selector").append($domesticFrame);

                        var $overseasFrame = $(document.createElement("DIV")).addClass("tabs-frame overseas");
                        if (Object.keys(cities.overseas).length) {
                            for (var _key in cities.overseas) {
                                $overseasFrame.append("<span>" + _key + "</span>");
                                cities.overseas[_key].forEach(function (city) {
                                    $overseasFrame.append("<a data-cityid=\"" + city.cityId + "\" data-pinyin=\"" + city.pinyin + "\" data-cityType=\"" + city.cityType + "\">" + city.cityName + "</a>");
                                });
                            }
                        }
                        $(".city-selector").append($overseasFrame);
                        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                        最后给dom节点绑定事件
                        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
                        _this.citySelectorEventDelegate();
                    }
                });
            });
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            点击汉堡菜单弹出子菜单
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".conning-tower .hamburg-menu").click(function () {
                $(document.body).css({ "overflow-y": "hidden" }); //滚动条隐藏
                $(".navigator-mask").fadeIn(100);
                $(".navigator-pop").animate({
                    right: 0
                }, 100);
            });
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            点击子菜单遮罩关闭子菜单
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".navigator-mask").click(function () {
                $(document.body).css({ "overflow-y": "auto" }); //如果有滚动条就显示  
                $(".navigator-mask").fadeOut(100);
                $(".navigator-pop").animate({
                    right: "-200px"
                }, 100);
            });
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            点击返回按钮回到假的搜索场景
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".conning-tower .back").click(function () {
                history.back();
            });
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            点击假的搜索区域出现真的搜索
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".conning-tower dl dd").click(function () {
                $(".substitute-mask").show(50);
            });
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            真搜索区域返回按钮事件监听
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".substitute-mask .search-substitute .back").click(function () {
                $(".substitute-mask").hide(50);
            });
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            真搜索区域清除输入图标事件监听
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".substitute-mask .search-substitute .input-section .icon-close").click(function () {
                $(".substitute-mask .search-substitute .input-section input").val("");
                $(".substitute-mask .list").empty();
            });
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            pop菜单中的下载APP菜单事件监听
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".navigator-pop .app-download").click(function () {
                nativeSchema.loadSchema({
                    schema: "external_call", // 通过NN打开某个链接
                    protocal: "wkzf", //schema头协议，实际情况填写
                    loadWaiting: "1500", //发起唤醒请求后，会等待loadWaiting时间，超时则跳转到failUrl，默认3000ms                
                    failUrl: "https://m.wkzf.com/download/transit?from=esfList", //唤起失败时的跳转链接，默认跳转到下载页
                    // apk信息,请根据实际情况填写
                    apkInfo: {
                        PKG: "com.wukong.ua",
                        CATEGORY: "android.intent.category.DEFAULT",
                        ACTION: "android.intent.action.VIEW"
                    }
                });
            });
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            真搜索区域输入监听
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var $input = $(".substitute-mask .search-substitute .input-section input");
            $input.keyup(function () {
                _this.request({
                    apiUrl: _this.apiUrl,
                    requestData: { "keyword": $.trim($input.val()) },
                    success: function success() {
                        //对获取到的搜索结果列表进行绘制
                    }
                });
            });
        }
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        本组件ajax请求封装
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

    }, {
        key: "request",
        value: function request(_ref2) {
            var apiUrl = _ref2.apiUrl,
                requestData = _ref2.requestData,
                _ref2$success = _ref2.success,
                _success = _ref2$success === undefined ? $.noop : _ref2$success;

            try {
                $.ajax({
                    url: apiUrl,
                    data: requestData,
                    dataType: "json",
                    error: function error(e) {
                        $.tips("调用数据接口：" + apiUrl + " 失败！请测试您的数据接口！", 3);
                    },
                    success: function success(data) {
                        if (data.status.toString() === "1") {
                            //获取到接口数据，进行处理
                            _success(data);
                        } else $.tips(data.message, 3);
                    }
                });
            } catch (e) {
                $.tips("错误名称：" + e.name + "\n错误描述：" + e.message, 3);
            }
        }
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        等渲染好城市选择器后进行的事件委托
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

    }, {
        key: "citySelectorEventDelegate",
        value: function citySelectorEventDelegate() {
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------         
            根据tabs-handle的显示状态决定tabs-frame的margin-top值
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var frameMarginTop = $(".city-selector .caption .tabs-handle").is(":visible") ? "72px" : "28px";
            $(".city-selector .tabs-frame").css({ "margin-top": frameMarginTop });
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------         
            城市选择器中根据tabs-handle里面哪个句柄被选中来确定哪个tabs-frame显示
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".city-selector .tabs-frame." + $(".city-selector .caption .tabs-handle li.on").eq(0).data("sign")).show();
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            城市选择器中tabs-handle的点击
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            var $tabsHandles = $(".city-selector .caption .tabs-handle li");
            $tabsHandles.click(function () {
                $tabsHandles.removeClass("on");
                $(this).addClass("on");
                $(".city-selector .tabs-frame").hide();
                $(".city-selector .tabs-frame." + $(this).data("sign")).show();
            });
            /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            城市选择器中每个城市被点击后干什么
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
            $(".city-selector .tabs-frame a").click(function () {
                $(".conning-tower dl dt span").text($(this).text());
                $(".city-selector").slideUp(200);
            });
        }
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        对接口拿到的业务开通城市进行处理
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

    }, {
        key: "filterBusinessCity",
        value: function filterBusinessCity(data) {
            var typeMapper = { "esf": 1, "rent": 2, "xf": 3 };
            var typeValue = typeMapper[this.moduleType];
            var result = { "domestic": {}, "overseas": {} };
            data && data.domesticCityList && data.domesticCityList.forEach(function (city) {
                var has = false;
                city.businessList && city.businessList.forEach(function (business) {
                    if (business.businessId === typeValue) has = true;
                });
                if (has) {
                    var shoupin = city.pinyin.charAt(0).toUpperCase();
                    if (!result.domestic.hasOwnProperty(shoupin)) result.domestic[shoupin] = [];
                    result.domestic[shoupin].push({ "cityId": city.cityId, "cityName": city.cityName, "pinyin": city.pinyin, "cityType": city.cityType });
                }
            });
            data && data.overseaCityList && data.overseaCityList.forEach(function (city) {
                var has = false;
                city.businessList && city.businessList.forEach(function (business) {
                    if (business.businessId === typeValue) has = true;
                });
                if (has) {
                    var shoupin = city.pinyin.charAt(0).toUpperCase();
                    result.overseas[shoupin].push({ "cityId": city.cityId, "cityName": city.cityName, "pinyin": city.pinyin, "cityType": city.cityType });
                }
            });
            return result;
        }
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        整个组件定义结束
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/

    }]);

    return ConningTower;
}();
//# sourceMappingURL=conning-tower.min.js.map
