"use strict";

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：悟空找房h5
 2. 页面名称：components -> bigdata(埋点)
 3. 作者：tangxuyang@lifang.com
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
define(function () {
    //获取设备Id
    function getDeviceId(cb) {
        //原生优先，然后取localStorage


        cb("2343434");
    }

    var ls = {};
    var getLocalStorage = function getLocalStorage() {
        return window.localStorage || ls;
    };

    //从localStorage中读取未成功的大数据埋点
    var getBigData = function getBigData() {
        if (getLocalStorage().bigData) {
            return JSON.parse(getLocalStorage().bigData);
        } else {
            return [];
        }
    };

    //设置未成功的大数据埋点到localStorage
    var setBigData = function setBigData(data) {
        getLocalStorage().bigData = JSON.stringify(data);
    };

    var getTotal = function getTotal() {
        if (getLocalStorage().bigDataTotal) {
            return parseInt(getLocalStorage().bigDataTotal);
        } else {
            return 1;
        }
    };

    var setTotal = function setTotal(total) {
        getLocalStorage().bigDataTotal = total;
    };

    //插入一条埋点数据到localStorage
    var insertBigData = function insertBigData(item) {
        var items = getBigData() || [];
        items.push(item);
        setBigData(items);
    };

    //发送埋点请求
    var send = function send(item) {
        if (window.controller) {
            var total = getTotal();
            var controller = window.controller;

            controller.request(controller.apiUrl.bigData, item, {
                successCallback: function successCallback() {}
            });
        }
    };

    //从localStorage中读取一个bigData发送出去
    var traverse = function traverse() {
        var items = getBigData();
        if (items && items.length > 0) {
            var item = items.splice(0, 1)[0];
            setBigData(items);
            send(item);
        }
    };

    function bigData(data) {
        getDeviceId(function (deviceId) {
            data.cookieId = deviceId;
            var total = getTotal();
            data.pNum = total;
            setTotal(total + 1);
            send(data);
        });
    };

    //body上注册click事件，监听click事件
    window.document.body.addEventListener("click", function (event) {
        //判断是否埋点元素
        var $target = $(event.target);
        var data = $target.data('bigdata');
        if (data) {
            data = JSON.parse(decodeURIComponent(data));
            data.type = 2; //事件埋点的类型是2,1是pv				
            bigData(data);
        } else {
            var $parents = $target.parents('[data-bigdata]');

            if ($parents.length > 0) {
                data = $parents.data('bigdata');
                data = JSON.parse(decodeURIComponent(data));
                data.type = 2;
                bigData(data);
            }
        }
    }, true);

    return {
        bigData: bigData
    };
});
//# sourceMappingURL=bigdata.min.js.map
